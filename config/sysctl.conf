# macOS Server Optimisation - sysctl Configuration
# These settings optimise the network stack for high-performance server workloads
#
# Format: parameter=value
# Lines starting with # are comments
#
# Sources:
# - ESnet Host Tuning (https://fasterdata.es.net/host-tuning/osx/)
# - Rolande's Network Stack Tuning for Sequoia 15.6 (https://rolande.wordpress.com/2025/08/07/performance-tuning-the-network-stack-on-macos-sequoia-15-6/)
# - Apple Server Performance Mode documentation (https://support.apple.com/en-us/101992)
# - RFC 7323: TCP Extensions for High Performance (https://www.rfc-editor.org/rfc/rfc7323)
#
# Default values verified on macOS Sequoia 15.6:
#   net.inet.tcp.mssdflt=512, sendspace=131702, recvspace=131702
#   autorcvbufmax=4194304, autosndbufmax=4194304, win_scale_factor=3
#

# ============================================================================
# TCP BUFFER SIZES
# Larger buffers allow more data in flight for high-bandwidth connections
# ============================================================================

# Default socket send buffer size (1MB for high throughput)
net.inet.tcp.sendspace=1048576

# Default socket receive buffer size (1MB for high throughput)
net.inet.tcp.recvspace=1048576

# Maximum auto-tuned receive buffer size (32MB for very high bandwidth, default 4MB)
net.inet.tcp.autorcvbufmax=33554432

# Maximum auto-tuned send buffer size (32MB for very high bandwidth, default 4MB)
net.inet.tcp.autosndbufmax=33554432

# Maximum socket buffer size (kernel limit - 16MB)
kern.ipc.maxsockbuf=16777216

# ============================================================================
# TCP PERFORMANCE PARAMETERS
# ============================================================================

# Maximum Segment Size default (1460 for standard Ethernet, was 512)
net.inet.tcp.mssdflt=1460

# Window scale factor (8 allows up to 16MB window, was 3)
net.inet.tcp.win_scale_factor=8

# Note: RFC 1323 timestamps and window scaling are enabled by default in macOS Sequoia

# Initial slow start flight size (20 packets for faster ramp-up)
net.inet.tcp.slowstart_flightsize=20

# Local network slow start flight size
net.inet.tcp.local_slowstart_flightsize=20

# Disable delayed ACK for lower latency (0=disabled, 3=auto-detect)
# Set to 0 for server workloads, 3 for mixed workloads
net.inet.tcp.delayed_ack=0

# Enable SACK (Selective Acknowledgement) for better recovery
net.inet.tcp.sack=1

# Always send TCP keepalive probes
net.inet.tcp.always_keepalive=1

# ============================================================================
# CONNECTION HANDLING
# ============================================================================

# Maximum pending connections queue (already set by serverperfmode)
# kern.ipc.somaxconn=2048

# Faster TIME_WAIT cleanup (milliseconds, default 15000)
net.inet.tcp.msl=5000

# ============================================================================
# SECURITY HARDENING (also helps performance by dropping junk)
# ============================================================================

# Drop TCP packets sent to closed ports (don't send RST - stealth mode)
net.inet.tcp.blackhole=2

# Drop UDP packets sent to closed ports
net.inet.udp.blackhole=1

# ============================================================================
# NOTES ON EXCLUDED SETTINGS
# ============================================================================
# The following are already well-tuned by serverperfmode=1:
# - kern.maxvnodes (1200000)
# - kern.maxproc (20000)
# - kern.maxfiles (1200000)
# - kern.maxfilesperproc (600000)
# - kern.maxprocperuid (15000)
# - kern.ipc.somaxconn (2048)
#
# We do NOT modify:
# - net.inet.ip.forwarding (routing, leave at 0 unless needed)
# - kern.sched_* (scheduler settings are auto-tuned)
# - net.inet.tcp.ecn (ECN can cause issues with some networks)
